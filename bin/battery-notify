#!/bin/sh

BATTERY_NOTIFY_HIGH=85
BATTERY_NOTIFY_LOW=35
PROGNAME=$(basename "$0")

if ! upower -e >/dev/null 2>&1; then
	echo "${PROGNAME}: upower is required"
	return 1
fi

if ! command -v notify-send >/dev/null; then
	echo "${PROGNAME}: libnotify-bin (notify-send) is required"
	return 1
fi

if [ -n "$1" ]; then
	notify_id=$1
fi

notify() {
	if [ -n "$notify_id" ]; then
		notify_id=$(notify-send -p -r "$notify_id" --urgency=critical "$PROGNAME" "$*")
	else
		notify_id=$(notify-send -p --urgency=critical "$PROGNAME" "$*")
	fi
}

set -e

bat_path=$(upower -e | grep -Fm1 "/battery_")
pow_path=$(upower -e | grep -Fm1 "/line_power_")

bat_percent=$(upower -i "$bat_path" | awk '/^[[:space:]]*percentage:/ {print substr($2, 1, length($2)-1)}')
pow_plugged=$(upower -i "$pow_path" | awk '/^[[:space:]]*online:/ {if ($2 == "yes") print 1}')

if [ -n "$pow_plugged" ]; then
	echo "Charging, ${bat_percent}%"

	if [ "$bat_percent" -gt $BATTERY_NOTIFY_HIGH ]; then
		notify "${bat_percent}%"
	fi
else
	echo "Discharging, ${bat_percent}%"

	if [ "$bat_percent" -lt $BATTERY_NOTIFY_LOW ]; then
		notify "${bat_percent}%"
	fi
fi


if [ -n "$notify_id" ]; then
	echo "$notify_id" >&2
fi
